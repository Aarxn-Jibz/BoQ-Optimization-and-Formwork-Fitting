{"ast":null,"code":"// ─── src/services/api.js ──────────────────────────────────────\n// Go backend: localhost:3000\n// Endpoint:   POST /api/optimize-kitting\n// CORS:       AllowOrigins: \"*\" (already set in Go)\n//\n// For teammate: set MOCK_MODE = false when Go server is running.\n// Input  shape: { items: [{ element_id, length, width, quantity, start_date, end_date }] }\n// Output shape: { original_boq_items, optimized_kits_required,\n//                 total_repetition_factor, estimated_cost_savings_percent, kit_details }\n// ─────────────────────────────────────────────────────────────\n\nimport { MOCK_OPTIMIZATION_RESULT, RUN_HISTORY, INVENTORY_DATA } from '../data/constants.js';\nconst MOCK_MODE = true; // ← set to false when Go server is running\nconst BASE = 'http://localhost:3000';\nconst TIMEOUT = 30000; // 30s — ML model may take time\n\nconst ENDPOINTS = {\n  OPTIMIZE: '/api/optimize-kitting',\n  // POST — main endpoint\n  HISTORY: '/api/history',\n  // GET  — add to Go later\n  INVENTORY: '/api/inventory',\n  // GET  — add to Go later\n  HEALTH: '/api/health' // GET  — add to Go later\n};\n\n/* ── fetch with timeout ──────────────────────────────────────── */\nasync function apiFetch(endpoint, options = {}) {\n  const controller = new AbortController();\n  const timer = setTimeout(() => controller.abort(), TIMEOUT);\n  try {\n    const res = await fetch(`${BASE}${endpoint}`, {\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      signal: controller.signal,\n      ...options\n    });\n    clearTimeout(timer);\n    if (!res.ok) {\n      const err = await res.json().catch(() => ({\n        error: res.statusText\n      }));\n      throw new Error(err.error || `HTTP ${res.status}`);\n    }\n    return await res.json();\n  } catch (err) {\n    clearTimeout(timer);\n    if (err.name === 'AbortError') throw new Error('Request timed out (30s)');\n    throw err;\n  }\n}\nconst mockDelay = (ms = 2000) => new Promise(r => setTimeout(r, ms));\n\n/* ══════════════════════════════════════════════════════════════\n   POST /api/optimize-kitting\n   Sends:   { items: FormworkItem[] }\n   Returns: OptimizationResponse matching Go struct exactly:\n   {\n     original_boq_items:         number,\n     optimized_kits_required:    number,\n     total_repetition_factor:    number,\n     estimated_cost_savings_percent: number,\n     kit_details: [{\n       dimensions:       string,   // e.g. \"2.40x1.20\"\n       required_qty:     number,\n       repetition_count: number,\n       used_in_elements: string[]\n     }]\n   }\n   ══════════════════════════════════════════════════════════════ */\nexport async function runOptimization(items) {\n  if (MOCK_MODE) {\n    await mockDelay(2200);\n\n    // Build mock response that mirrors real Go output shape exactly\n    const totalQty = items.reduce((s, i) => s + Number(i.quantity), 0);\n\n    // Group by dimensions to simulate Go's groupedByDims logic\n    const groups = {};\n    items.forEach(item => {\n      const key = `${Number(item.length).toFixed(2)}x${Number(item.width).toFixed(2)}`;\n      if (!groups[key]) groups[key] = {\n        elements: [],\n        qty: 0\n      };\n      groups[key].elements.push(item.element_id);\n      groups[key].qty += Number(item.quantity);\n    });\n    const kit_details = Object.entries(groups).map(([dims, g]) => {\n      const reqQty = Math.ceil(g.qty / 10); // simplified mock: 10 reuses max\n      return {\n        dimensions: dims,\n        required_qty: reqQty,\n        repetition_count: Math.round(g.qty / reqQty * 100) / 100,\n        used_in_elements: g.elements\n      };\n    });\n    const optimizedTotal = kit_details.reduce((s, k) => s + k.required_qty, 0);\n    const savings = totalQty > 0 ? Math.round((totalQty - optimizedTotal) / totalQty * 100 * 100) / 100 : 0;\n    return {\n      original_boq_items: totalQty,\n      optimized_kits_required: optimizedTotal,\n      total_repetition_factor: Math.round(totalQty / optimizedTotal * 100) / 100,\n      estimated_cost_savings_percent: savings,\n      kit_details,\n      // extra fields for UI (not from Go, added client-side)\n      _run_id: `RUN-${Date.now()}`,\n      _processed_at: new Date().toISOString()\n    };\n  }\n\n  // Real Go call\n  return apiFetch(ENDPOINTS.OPTIMIZE, {\n    method: 'POST',\n    body: JSON.stringify({\n      items\n    })\n  });\n}\n\n/* ══════════════════════════════════════════════════════════════\n   GET /api/history  (mock only for now)\n   ══════════════════════════════════════════════════════════════ */\nexport async function fetchHistory() {\n  if (MOCK_MODE) {\n    await mockDelay(500);\n    return RUN_HISTORY;\n  }\n  return apiFetch(ENDPOINTS.HISTORY);\n}\n\n/* ══════════════════════════════════════════════════════════════\n   GET /api/inventory  (mock only for now)\n   ══════════════════════════════════════════════════════════════ */\nexport async function fetchInventory() {\n  if (MOCK_MODE) {\n    await mockDelay(500);\n    return INVENTORY_DATA;\n  }\n  return apiFetch(ENDPOINTS.INVENTORY);\n}\n\n/* ══════════════════════════════════════════════════════════════\n   GET /api/health\n   ══════════════════════════════════════════════════════════════ */\nexport async function checkHealth() {\n  if (MOCK_MODE) {\n    await mockDelay(200);\n    return {\n      status: 'ok',\n      version: '1.0.0-mock',\n      mode: 'mock'\n    };\n  }\n  return apiFetch(ENDPOINTS.HEALTH);\n}","map":{"version":3,"names":["MOCK_OPTIMIZATION_RESULT","RUN_HISTORY","INVENTORY_DATA","MOCK_MODE","BASE","TIMEOUT","ENDPOINTS","OPTIMIZE","HISTORY","INVENTORY","HEALTH","apiFetch","endpoint","options","controller","AbortController","timer","setTimeout","abort","res","fetch","headers","signal","clearTimeout","ok","err","json","catch","error","statusText","Error","status","name","mockDelay","ms","Promise","r","runOptimization","items","totalQty","reduce","s","i","Number","quantity","groups","forEach","item","key","length","toFixed","width","elements","qty","push","element_id","kit_details","Object","entries","map","dims","g","reqQty","Math","ceil","dimensions","required_qty","repetition_count","round","used_in_elements","optimizedTotal","k","savings","original_boq_items","optimized_kits_required","total_repetition_factor","estimated_cost_savings_percent","_run_id","Date","now","_processed_at","toISOString","method","body","JSON","stringify","fetchHistory","fetchInventory","checkHealth","version","mode"],"sources":["C:/Users/JOEL DSILVA/OneDrive/Desktop/Projects/BoQ_Formwork_Fitting/obsidian-core/src/services/api.js"],"sourcesContent":["// ─── src/services/api.js ──────────────────────────────────────\n// Go backend: localhost:3000\n// Endpoint:   POST /api/optimize-kitting\n// CORS:       AllowOrigins: \"*\" (already set in Go)\n//\n// For teammate: set MOCK_MODE = false when Go server is running.\n// Input  shape: { items: [{ element_id, length, width, quantity, start_date, end_date }] }\n// Output shape: { original_boq_items, optimized_kits_required,\n//                 total_repetition_factor, estimated_cost_savings_percent, kit_details }\n// ─────────────────────────────────────────────────────────────\n\nimport { MOCK_OPTIMIZATION_RESULT, RUN_HISTORY, INVENTORY_DATA } from '../data/constants.js'\n\nconst MOCK_MODE = true        // ← set to false when Go server is running\nconst BASE      = 'http://localhost:3000'\nconst TIMEOUT   = 30000       // 30s — ML model may take time\n\nconst ENDPOINTS = {\n  OPTIMIZE:  '/api/optimize-kitting', // POST — main endpoint\n  HISTORY:   '/api/history',          // GET  — add to Go later\n  INVENTORY: '/api/inventory',        // GET  — add to Go later\n  HEALTH:    '/api/health',           // GET  — add to Go later\n}\n\n/* ── fetch with timeout ──────────────────────────────────────── */\nasync function apiFetch(endpoint, options = {}) {\n  const controller = new AbortController()\n  const timer = setTimeout(() => controller.abort(), TIMEOUT)\n  try {\n    const res = await fetch(`${BASE}${endpoint}`, {\n      headers: { 'Content-Type': 'application/json' },\n      signal: controller.signal,\n      ...options,\n    })\n    clearTimeout(timer)\n    if (!res.ok) {\n      const err = await res.json().catch(() => ({ error: res.statusText }))\n      throw new Error(err.error || `HTTP ${res.status}`)\n    }\n    return await res.json()\n  } catch (err) {\n    clearTimeout(timer)\n    if (err.name === 'AbortError') throw new Error('Request timed out (30s)')\n    throw err\n  }\n}\n\nconst mockDelay = (ms = 2000) => new Promise(r => setTimeout(r, ms))\n\n/* ══════════════════════════════════════════════════════════════\n   POST /api/optimize-kitting\n   Sends:   { items: FormworkItem[] }\n   Returns: OptimizationResponse matching Go struct exactly:\n   {\n     original_boq_items:         number,\n     optimized_kits_required:    number,\n     total_repetition_factor:    number,\n     estimated_cost_savings_percent: number,\n     kit_details: [{\n       dimensions:       string,   // e.g. \"2.40x1.20\"\n       required_qty:     number,\n       repetition_count: number,\n       used_in_elements: string[]\n     }]\n   }\n   ══════════════════════════════════════════════════════════════ */\nexport async function runOptimization(items) {\n  if (MOCK_MODE) {\n    await mockDelay(2200)\n\n    // Build mock response that mirrors real Go output shape exactly\n    const totalQty = items.reduce((s, i) => s + Number(i.quantity), 0)\n\n    // Group by dimensions to simulate Go's groupedByDims logic\n    const groups = {}\n    items.forEach(item => {\n      const key = `${Number(item.length).toFixed(2)}x${Number(item.width).toFixed(2)}`\n      if (!groups[key]) groups[key] = { elements: [], qty: 0 }\n      groups[key].elements.push(item.element_id)\n      groups[key].qty += Number(item.quantity)\n    })\n\n    const kit_details = Object.entries(groups).map(([dims, g]) => {\n      const reqQty = Math.ceil(g.qty / 10)   // simplified mock: 10 reuses max\n      return {\n        dimensions:       dims,\n        required_qty:     reqQty,\n        repetition_count: Math.round((g.qty / reqQty) * 100) / 100,\n        used_in_elements: g.elements,\n      }\n    })\n\n    const optimizedTotal = kit_details.reduce((s, k) => s + k.required_qty, 0)\n    const savings = totalQty > 0\n      ? Math.round(((totalQty - optimizedTotal) / totalQty) * 100 * 100) / 100\n      : 0\n\n    return {\n      original_boq_items:             totalQty,\n      optimized_kits_required:        optimizedTotal,\n      total_repetition_factor:        Math.round((totalQty / optimizedTotal) * 100) / 100,\n      estimated_cost_savings_percent: savings,\n      kit_details,\n      // extra fields for UI (not from Go, added client-side)\n      _run_id:       `RUN-${Date.now()}`,\n      _processed_at: new Date().toISOString(),\n    }\n  }\n\n  // Real Go call\n  return apiFetch(ENDPOINTS.OPTIMIZE, {\n    method: 'POST',\n    body: JSON.stringify({ items }),\n  })\n}\n\n/* ══════════════════════════════════════════════════════════════\n   GET /api/history  (mock only for now)\n   ══════════════════════════════════════════════════════════════ */\nexport async function fetchHistory() {\n  if (MOCK_MODE) {\n    await mockDelay(500)\n    return RUN_HISTORY\n  }\n  return apiFetch(ENDPOINTS.HISTORY)\n}\n\n/* ══════════════════════════════════════════════════════════════\n   GET /api/inventory  (mock only for now)\n   ══════════════════════════════════════════════════════════════ */\nexport async function fetchInventory() {\n  if (MOCK_MODE) {\n    await mockDelay(500)\n    return INVENTORY_DATA\n  }\n  return apiFetch(ENDPOINTS.INVENTORY)\n}\n\n/* ══════════════════════════════════════════════════════════════\n   GET /api/health\n   ══════════════════════════════════════════════════════════════ */\nexport async function checkHealth() {\n  if (MOCK_MODE) {\n    await mockDelay(200)\n    return { status: 'ok', version: '1.0.0-mock', mode: 'mock' }\n  }\n  return apiFetch(ENDPOINTS.HEALTH)\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}